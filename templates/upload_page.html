<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload and Print Preview</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link href="./../static/css/upload_page.css" rel="stylesheet">
    <link href="./../static/css/header.css" rel="stylesheet">
    <style>
      .step { display: none; }
      .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }
      .stepper {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }
      .stepper .step-indicator {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #ddd;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          color: #333;
          font-size: 18px;
          position: relative;
          transition: background 0.3s, color 0.3s;
      }
      .stepper .step-indicator.active {
          background: #700000;
          color: white;
      }
      .stepper .step-indicator:not(:last-child)::after {
          content: '';
          position: absolute;
          width: 500px;
          height: 4px;
          background: #ddd;
          top: 50%;
          left: 50%;
          transform: translateX(20px);
      }
      .stepper .step-indicator.active:not(:last-child)::after {
          background: #700000;
      }

      .preview-container {
        max-height: 400px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        width: 300px;
      }
      .preview-page {
        margin-bottom: 10px;
        border: 1px solid #ddd;
      }
      .preview-page img {
        max-width: 100%;
        display: block;
        margin: auto;
      }
      .modal-body {
        display: flex;
      }
      .form-section {
        flex: 1;
      }
      .preview-section {
        flex: 1;
        margin-left: 20px;
      }
  </style>
  </head>
  <body>
    <header class="header">
      <!-- Left logo -->
      <img src="./../static/images/pup-logo.png" alt="sample" />

      <!-- Center text -->
      <div class="center-text">INSTAPRINT <h6>WIRELESS FILE TRANSFER</h6></div>

      <!-- Right logo -->
      <img src="./../static/images/cpe-logo.png" alt="sample" />
    </header>

    <div class="container">
      <div class="stepper">
          <div class="step-indicator active" id="step1-indicator">1</div>
          <div class="step-indicator" id="step2-indicator">2</div>
          <div class="step-indicator" id="step3-indicator">3</div>
      </div>

      <div class="step active" id="step1">
          <h2>Step 1: Go to ToffeeShare</h2>
          <p>Use the QR code or type the link below:</p>
          <img src="./../static/images/toffeshare.png" height="120px" alt="toffeshare"> 
          <b>https://toffeeshare.com/</b>
          <button class="btn btn-primary next-btn flex">Next</button>
      </div>

      <div class="step" id="step2">
          <h2>Step 2: Click the Link Below</h2>
          <a href="{{ toffee_share_link }}" target="_blank">Upload to ToffeeShare</a>
          <p>Follow the instructions on ToffeeShare.</p>
          <button class="btn btn-secondary prev-btn">Previous</button>
          <button class="btn btn-primary next-btn">Next</button>
      </div>

      <div class="step" id="step3">
          <h2>Step 3: Upload Your File</h2>
          <form id="uploadForm">
              <div class="form-group">
                  <label for="file">Choose a file</label>
                  <input type="file" class="form-control" id="file" name="file" required />
              </div>
              <button class="btn btn-secondary prev-btn">Previous</button>
              <button type="submit" class="btn btn-success">Upload</button>
          </form>
      </div>
  </div>

  

      <div id="printOptionsModal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header" style="background-color: #700000;">
              <h5 class="modal-title">Print Options</h5>
            </div>
            <div class="modal-body">
              <div class="form-section">
                <div class="form-group">
                  <label for="pageFrom">Page From</label>
                  <input
                    type="number"
                    id="pageFrom"
                    class="form-control"
                    placeholder="1"
                    min="1"
                  />
                </div>
                <div class="form-group">
                  <label for="pageTo">Page To</label>
                  <input
                    type="number"
                    id="pageTo"
                    class="form-control"
                    placeholder="1"
                    min="1"
                  />
                </div>
                <div class="form-group">
                  <label for="numCopies">Number of Copies</label>
                  <input
                    type="number"
                    id="numCopies"
                    class="form-control"
                    value="1"
                    min="1"
                  />
                </div>
                <div class="form-group">
                  <label for="pageSize">Page Size</label>
                  <select id="pageSize" class="form-control">
                    <option value="A4">A4</option>
                    <option value="Short">Short</option>
                    <option value="Long">Long</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="colorOption">Color Option</label>
                  <select id="colorOption" class="form-control">
                    <option value="Color">Color</option>
                    <option value="Grayscale">Grayscale</option>
                  </select>
                </div>
              </div>
              <div class="preview-section">
                <h6>File: <span id="fileName"></span></h6>
                <h6>Total Pages: <span id="totalPages"></span></h6>
                <h6>Preview</h6>
                <div id="previewContainer" class="preview-container"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                id="closeModalBtn"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Exit
              </button>
              <button id="continueBtn" class="btn btn-primary">Continue</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentStep = 1;
      function showStep(step) {
          $('.step').removeClass('active');
          $('#step' + step).addClass('active');
          $('.step-indicator').removeClass('active');
          $('#step' + step + '-indicator').addClass('active');
      }

      $('.next-btn').on('click', function () {
          if (currentStep < 3) {
              currentStep++;
              showStep(currentStep);
          }
      });

      $('.prev-btn').on('click', function () {
          if (currentStep > 1) {
              currentStep--;
              showStep(currentStep);
          }
      });
  </script>
    <script>
      let previewTimeout;
      let totalPages = 0;
      let fileName = "";

      $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        $.ajax({
          url: "/upload",
          method: "POST",
          data: formData,
          contentType: false,
          processData: false,
          success: function (response) {
            fileName = response.fileName;
            totalPages = response.totalPages;
            $("#fileName").text(fileName);
            $("#totalPages").text(totalPages);
            $("#printOptionsModal").modal("show");

            $("#pageFrom").val(1);
            $("#pageTo").val(totalPages);

            updatePreview();
          },
          error: function (err) {
            alert(err.responseJSON.error || "Upload failed.");
          },
        });
      });

      function updatePreview() {
        const pageFrom = $("#pageFrom").val();
        const pageTo = $("#pageTo").val();
        const numCopies = $("#numCopies").val();
        const pageSize = $("#pageSize").val();
        const colorOption = $("#colorOption").val();

        if (!pageFrom || !pageTo || pageFrom > pageTo || pageTo > totalPages)
          return;

        clearTimeout(previewTimeout);

        previewTimeout = setTimeout(() => {
          $.ajax({
            url: "/generate_preview",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({
              pageFrom,
              pageTo,
              numCopies,
              pageSize,
              colorOption,
            }),
            success: function (response) {
              const previewContainer = $("#previewContainer");
              previewContainer.empty();

              response.previews.forEach((preview) => {
                const timestampedURL = preview + "?t=" + new Date().getTime();
                const pageDiv = $("<div>")
                  .addClass("preview-page")
                  .append($("<img>").attr("src", timestampedURL));
                previewContainer.append(pageDiv);
              });
            },
            error: function (error) {
              console.error(
                error.responseJSON.error || "Failed to generate previews."
              );
            },
          });
        }, 300);
      }

      $("#pageFrom, #pageTo, #numCopies, #pageSize, #colorOption").on(
        "input change",
        function () {
          updatePreview();
        }
      );

      $("#continueBtn").on("click", function () {
        const options = {
          pageFrom: $("#pageFrom").val(),
          pageTo: $("#pageTo").val(),
          numCopies: $("#numCopies").val(),
          pageSize: $("#pageSize").val(),
          colorOption: $("#colorOption").val(),
          fileName: fileName,
        };

        // Store options in session storage to retrieve in result.html
        sessionStorage.setItem("printOptions", JSON.stringify(options));

        // Redirect to result.html
        window.location.href = "/result";
      });
    </script>
  </body>
</html>
